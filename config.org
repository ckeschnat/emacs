#+SETUPFILE: themes/theme-readtheorg-local.setup
#+OPTIONS: html-postamble:nil num:nil
#+FILETAGS: emacs
#+TITLE: Emacs config

* Introduction
Headings tagged "CANCELLED" will not be tangled.
* UI
https://huytd.github.io/emacs-from-scratch.html

https://superuser.com/questions/313398/how-to-prevent-the-symbols-function-definition-is-void-error-when-running-em
*** Misc
#+BEGIN_SRC emacs-lisp
  ;; Minimal UI
  (when (display-graphic-p)
    (progn
      (scroll-bar-mode -1)
      (tool-bar-mode   -1)))
  (tooltip-mode    -1)
  (menu-bar-mode   -1)
  (setq inhibit-splash-screen t)
#+END_SRC
*** Font
Set Symbola as fallback font to display unicode characters.
#+BEGIN_SRC emacs-lisp
  (set-fontset-font "fontset-default" nil
    (font-spec :size 20 :name "Symbola"))

  (add-to-list 'default-frame-alist '(font . "Liberation Mono"))
  (add-to-list 'initial-frame-alist '(fullscreen . maximized))
  (add-to-list 'default-frame-alist '(fullscreen . fullheight))
#+END_SRC
*** Theme
#+BEGIN_SRC emacs-lisp
  ;; Theme
  (add-to-list 'custom-theme-load-path "~/.emacs.d/themes/")
    (setq zenburn-override-colors-alist '(
                                          ("zenburn-bg-05" . "#131818")
                                          ("zenburn-bg-1" . "#6A714A")
                                          ))
  (load-theme 'zenburn t)

  ;;(use-package doom-themes
  ;;  :ensure t
  ;;  :config
  ;;  (load-theme 'doom-one t))
#+END_SRC

https://github.com/jasonm23/emacs-select-themes
#+BEGIN_SRC emacs-lisp
  (defun select-themes (theme)
    "Interactively select a THEME, from the available custom themes.
  You can also select '*Emacs default*' to return to Emacs default theme.
  Note: multiple enabled themes cause Emacs to slow down, so we
  disable them before selecting the new theme."
    (interactive (list (completing-read "Select theme: "
                                  (sort (custom-available-themes) 'string<)
                                  nil nil nil nil
                                  "*Emacs default*")))
    (mapc 'disable-theme custom-enabled-themes)
    (unless (string= "*Emacs default*" theme)
      (load-theme (intern-soft theme))))

  (provide 'select-themes)
#+END_SRC
* Packages and use-package
#+BEGIN_SRC emacs-lisp
  ;; Package configs
  (require 'package)
  (setq package-enable-at-startup nil)
  (setq package-archives '(("org"   . "http://orgmode.org/elpa/")
                           ("gnu"   . "http://elpa.gnu.org/packages/")
                           ("melpa" . "https://melpa.org/packages/")))
  (package-initialize)

  ;; Bootstrap `use-package`
  (unless (package-installed-p 'use-package)
    (package-refresh-contents)
    (package-install 'use-package))
  (require 'use-package)
#+END_SRC

* Misc
*** Paths
#+BEGIN_SRC emacs-lisp
  (setenv "PATH" (concat "C:\\msys64\\usr\\bin;" "C:\\msys64\\mingw64\\bin;" "C:\\texlive\\2018\\bin\\win32;" "w:\\handmade\\misc;" (getenv "PATH")))
#+END_SRC
*** Encoding
See [[https://www.masteringemacs.org/article/working-coding-systems-unicode-emacs][masteringemacs]] and [[https://zhangda.wordpress.com/2016/02/15/configurations-for-beautifying-emacs-org-mode/]]
#+BEGIN_SRC emacs-lisp
  ;; disable CJK coding/encoding (Chinese/Japanese/Korean characters)
  (setq utf-translate-cjk-mode nil)

  (set-language-environment 'utf-8)
  (setq locale-coding-system 'utf-8)

  ;; set the default encoding system
  (prefer-coding-system 'utf-8)
  (setq default-file-name-coding-system 'utf-8)
  (set-default-coding-systems 'utf-8)
  (set-terminal-coding-system 'utf-8)
  (set-keyboard-coding-system 'utf-8)
  ;; backwards compatibility as default-buffer-file-coding-system
  ;; is deprecated in 23.2.
  (if (boundp buffer-file-coding-system)
      (setq buffer-file-coding-system 'utf-8)
    (setq default-buffer-file-coding-system 'utf-8))

  ;; Treat clipboard input as UTF-8 string first; compound text next, etc.
  (setq x-select-request-type '(UTF8_STRING COMPOUND_TEXT TEXT STRING))
#+END_SRC
*** Customize
#+BEGIN_SRC emacs-lisp
  (setq custom-file "~/.emacs.d/custom.el")
  (load custom-file 'noerror)
#+END_SRC
*** Help
#+BEGIN_SRC emacs-lisp
  (setq help-window-select t)
  (use-package helpful
    :ensure t
    :config
      (general-define-key
        :states '(normal visual insert emacs)
        :prefix "C-h"
        :non-normal-prefix "C-M-h"
        "v" '(helpful-variable :which-key "helpful-variable")
        "f" '(helpful-function :which-key "helpful-function"))

      (general-define-key
        :states '(normal visual insert emacs)
        :prefix "SPC"
        :non-normal-prefix "M-SPC"
        "h"  '(:ignore t :which-key "Help")
        "hv" '(helpful-variable :which-key "helpful-variable")
        "hf" '(helpful-function :which-key "helpful-function")))
#+END_SRC
*** Parens
#+BEGIN_SRC emacs-lisp
  ;; Show matching parens
  (setq show-paren-delay 0)
  (show-paren-mode 1)
#+END_SRC
*** Change "yes or no" to "y or n"
#+BEGIN_SRC emacs-lisp
  (fset 'yes-or-no-p 'y-or-n-p)
#+END_SRC
*** Backup, autosaves and lock files
#+BEGIN_SRC emacs-lisp
  ;; Set backup directory
  (setq backup-directory-alist '(("." . "~/.emacs.d/backups")))

  (setq delete-old-versions -1)
  (setq version-control t)
  (setq vc-make-backup-files t)
  (setq auto-save-file-name-transforms '((".*" "~/.emacs.d/auto-save-list/" t)))

  ;; No lock files
  (setq create-lockfiles nil)
#+END_SRC
*** History
#+BEGIN_SRC emacs-lisp
  (setq savehist-file "~/.emacs.d/savehist")
  (savehist-mode 1)
  (setq history-length t)
  (setq history-delete-duplicates t)
  (setq savehist-save-minibuffer-history 1)
  (setq savehist-additional-variables
        '(kill-ring
          search-ring
          regexp-search-ring))
#+END_SRC
*** Time in modeline
#+BEGIN_SRC emacs-lisp
  (display-time-mode 1)
#+END_SRC
*** Sentences end with a single space
#+BEGIN_SRC emacs-lisp
  (setq sentence-end-double-space nil)
#+END_SRC
*** Winner
#+BEGIN_SRC emacs-lisp
  (winner-mode 1)
#+END_SRC
*** persistent undo
#+BEGIN_SRC emacs-lisp
  (setq undo-tree-auto-save-history t)
  (setq undo-tree-history-directory-alist '(("." . "~/.emacs.d/undo")))
#+END_SRC
*** Undo tree mode - visualize your undos and branches

People often struggle with the Emacs undo model, where there's really no concept of "redo" - you simply undo the undo.
#
This lets you use =C-x u= (=undo-tree-visualize=) to visually walk through the changes you've made, undo back to a certain point (or redo), and go down different branches.

#+BEGIN_SRC emacs-lisp
  (use-package undo-tree
    :diminish undo-tree-mode
    :config
    (progn
      (global-undo-tree-mode)
      (setq undo-tree-visualizer-timestamps t)
      (setq undo-tree-visualizer-diff t))

    (general-define-key
      :states '(normal visual insert emacs)
      :prefix "SPC"
      :non-normal-prefix "M-SPC"
      "u"  '(:ignore t :which-key "Undo")
      "uv" '(undo-tree-visualize :which-key "Visualize")))
#+END_SRC
*** center after search
#+BEGIN_SRC emacs-lisp
  ;; center after search
  (setq scroll-conservatively 0)
#+END_SRC
*** filetypes to modes
#+BEGIN_SRC emacs-lisp
  (add-to-list 'auto-mode-alist '("\\.asciidoc\\'" . adoc-mode))
  (add-to-list 'auto-mode-alist '("\\.txt\\'" . org-mode))
#+END_SRC
*** tramp
https://rentes.github.io/emacs/windows/ssh/2016/08/25/Editing-Remote-Files-With-Emacs-Under-Windows/

#+BEGIN_SRC emacs-lisp
  (use-package tramp
    :ensure t
    :config
      (when (eq system-type 'windows-nt)
        (set-default 'tramp-auto-save-directory "C:\\Users\\chris.keschnat\\AppData\\Local\\Temp")
        (set-default 'tramp-default-method "plink")))
#+END_SRC
*** smart-mode-line
#+BEGIN_SRC emacs-lisp
  (use-package smart-mode-line
    :ensure t
    :config
      (sml/setup))
#+END_SRC
* Evil
[[https://github.com/emacs-evil/evil-collection][Evil-Collection]]

[[https://github.com/Somelauw/evil-org-mode][evil-org]]

#+BEGIN_SRC emacs-lisp
  ;; Vim mode
  (use-package evil
    :ensure t
    :init
    (setq evil-want-integration t) ;; This is optional since it's already set to t by default.
    (setq evil-want-keybinding nil)
    :config
    (evil-mode 1))

  (use-package evil-escape
    :ensure t
    :init
    (setq-default evil-escape-key-sequence "fd")
    :config
    (evil-escape-mode 1))

  (use-package evil-collection
    :after evil
    :ensure t
    :config
    (evil-collection-init))

  (use-package evil-org
    :ensure t
    :after org
    :config
    (add-hook 'org-mode-hook 'evil-org-mode)
    (add-hook 'evil-org-mode-hook
              (lambda ()
                (evil-org-set-key-theme)))
    (require 'evil-org-agenda)
    (evil-org-agenda-set-keys))

  (defun my-center-line (&rest _)
    (evil-scroll-line-to-center nil))

  (advice-add 'evil-search-next :after #'my-center-line)
#+END_SRC
*** Lispyville
https://github.com/noctuid/lispyville

Just because of

#+BEGIN_QUOTE
If you are just looking for a way to prevent evil’s
operators from unbalancing parentheses, you can enable lispyville-mode
in your configuration and just ignore the rest of its features.
#+END_QUOTE

#+BEGIN_SRC emacs-lisp
  (use-package lispyville
   :ensure t)

  (add-hook 'emacs-lisp-mode-hook #'lispyville-mode)
  (add-hook 'lisp-mode-hook #'lispyville-mode)
#+END_SRC
* General
Key bindings.
**** TODO move some of these somewhere else
#+BEGIN_SRC emacs-lisp
  ;; Custom keybinding
  (use-package general
    :ensure t
    :config
    (general-evil-setup t)

    (general-define-key
      :prefix "C-c"
      ;; bind "C-c a" to 'org-agenda
      "a" 'org-agenda
      "b" 'counsel-bookmark
      "c" 'org-capture)

    (general-define-key
      :states '(normal visual insert emacs)
      :prefix "SPC"
      :non-normal-prefix "M-SPC"
      "TAB" '(spacemacs/alternate-buffer :which-key "previous buffer")
      ;; Window
      "w"  '(:ignore t :which-key "Windows")
      "wl"  '(windmove-right :which-key "move right")
      "wh"  '(windmove-left :which-key "move left")
      "wk"  '(windmove-up :which-key "move up")
      "wj"  '(windmove-down :which-key "move bottom")
      "w/"  '(split-window-right :which-key "split right")
      "w-"  '(split-window-below :which-key "split bottom")
      "wd"  '(delete-window :which-key "delete window")
      ;; Files
      "f"  '(:ignore t :which-key "Files")
      ;; Buffers
      "b"  '(:ignore t :which-key "Buffers")
      "bd"  '(kill-this-buffer :which-key "delete buffer")
      ;; Search
      "s"  '(:ignore t :which-key "Search")
      ;; Others
      "o"  '(:ignore t :which-key "Other")))
#+END_SRC

* Ivy
Use amx to save recent M-x items

#+BEGIN_SRC emacs-lisp
  (use-package amx
    :ensure t)
#+END_SRC

#+BEGIN_SRC emacs-lisp
  (use-package ivy
    :ensure t
    :defer 0.1
    :diminish (ivy-mode . "") ; does not display ivy in the modeline
    :init (ivy-mode 1)        ; enable ivy globally at startup
    ;:bind (:map ivy-mode-map  ; bind in the ivy buffer
    ;       ("C-'" . ivy-avy)) ; C-' to ivy-avy
    :config
    (setq ivy-use-virtual-buffers t)    ; extend searching to bookmarks and
    (setq ivy-height 20)                ; set height of the ivy window
    (setq ivy-count-format "(%d/%d) ")  ; count format, from the ivy help page
    (setq ivy-initial-inputs-alist nil) ; no "^" at beginning
    )

  (general-define-key
    :states '(normal visual insert emacs)
    :prefix "SPC"
    :non-normal-prefix "M-SPC"
    "SPC" '(counsel-M-x :which-key "M-x")
    ;; Buffers
    "bb"  '(ivy-switch-buffer :which-key "buffers list")
    ;; Files
    "ff"  '(counsel-find-file :which-key "find files")
    "fr"  '(counsel-recentf :which-key "recent files")
    ;; Search
    "ss"   '(swiper :which-key "swiper")
    "sa"   '(swiper-all :which-key "swiper-all")
    ;; "/"   '(counsel-rg :which-key "ripgrep") ; You'll need counsel package for this
  )

  ;; https://www.reddit.com/r/emacs/comments/910pga/tip_how_to_use_ivy_and_its_utilities_in_your/
  (use-package ivy-rich
    :ensure t
    :after ivy
    :custom
    (ivy-virtual-abbreviate 'full
                            ivy-rich-switch-buffer-align-virtual-buffer t
                            ivy-rich-path-style 'abbrev)
    :config
    (ivy-rich-mode 1)


    (setq ivy-rich--display-transformers-list
        ;;'(ivy-switch-buffer
        ;;  (:columns
        ;;   ((ivy-rich-candidate (:width 30))
        ;;    (ivy-rich-switch-buffer-size (:width 7))
        ;;    (ivy-rich-switch-buffer-indicators (:width 4 :face error :align right))
        ;;    (ivy-rich-switch-buffer-major-mode (:width 12 :face warning))
        ;;    (ivy-rich-switch-buffer-project (:width 15 :face success))
        ;;    (ivy-rich-switch-buffer-path (:width (lambda (x) (ivy-rich-switch-buffer-shorten-path x (ivy-rich-minibuffer-width 0.3))))))
        ;;   :predicate
        ;;   (lambda (cand) (get-buffer cand)))))
     '(ivy-switch-buffer
       (:columns
        ((ivy-rich-candidate (:width 30))  ; return the candidate itself
         (ivy-rich-switch-buffer-size (:width 7))  ; return the buffer size
         (ivy-rich-switch-buffer-indicators (:width 4 :face error :align right)); return the buffer indicators
         (ivy-rich-switch-buffer-major-mode (:width 12 :face warning))          ; return the major mode info
         (ivy-rich-switch-buffer-project (:width 15 :face success))             ; return project name using `projectile'
         (ivy-rich-switch-buffer-path (:width (lambda (x) (ivy-rich-switch-buffer-shorten-path x (ivy-rich-minibuffer-width 0.3))))))  ; return file path relative to project root or `default-directory' if project is nil
        :predicate
        (lambda (cand) (get-buffer cand)))
       counsel-M-x
       (:columns
        ((counsel-M-x-transformer (:width 40))  ; thr original transfomer
         (ivy-rich-counsel-function-docstring (:face font-lock-doc-face))))  ; return the docstring of the command
       counsel-describe-function
       (:columns
        ((counsel-describe-function-transformer (:width 40))  ; the original transformer
         (ivy-rich-counsel-function-docstring (:face font-lock-doc-face))))  ; return the docstring of the function
       counsel-describe-variable
       (:columns
        ((counsel-describe-variable-transformer (:width 40))  ; the original transformer
         (ivy-rich-counsel-variable-docstring (:face font-lock-doc-face))))  ; return the docstring of the variable
       counsel-recentf
       (:columns
        ((ivy-rich-candidate (:width 0.8)) ; return the candidate itself
         (ivy-rich-file-last-modified-time (:face font-lock-comment-face)))))) ; return the last modified time of the file
  )


  (use-package swiper
    :ensure t
    :after ivy)

  ;(use-package avy :ensure t)
  (use-package counsel
    :ensure t
    :diminish
    :after ivy
  ;  :bind*                           ; load counsel when pressed
  ;  (("M-x"     . counsel-M-x)       ; M-x use counsel
  ;   ("C-x C-f" . counsel-find-file) ; C-x C-f use counsel-find-file
  ;   ("C-x C-r" . counsel-recentf)   ; search recently edited files
  ;   ("C-c f"   . counsel-git)       ; search for files in git repo
  ;   ("C-c s"   . counsel-git-grep)  ; search for regexp in git repo
  ;   ("C-c /"   . counsel-ag)        ; search for regexp in git repo using ag
  ;   ("C-c l"   . counsel-locate))   ; search for files or else using locate
    )

  (general-define-key
    :states '(normal visual insert emacs)
    "C-s" 'swiper
    "M-x" 'counsel-M-x)

  ; fuzzy matching except with swiper
  (setq ivy-re-builders-alist
        '((swiper . ivy--regex-plus)
          (t      . ivy--regex-fuzzy)))
#+END_SRC
* Which-key
#+BEGIN_SRC emacs-lisp
;; Which Key
(use-package which-key
  :ensure t
  :init
  (setq which-key-separator " ")
  (setq which-key-prefix-prefix "+")
  :config
  (which-key-mode 1))
#+END_SRC
* Ranger
#+BEGIN_SRC emacs-lisp
  (use-package ranger
  :ensure t
  :config

    (general-define-key
      :states '(normal visual insert emacs)
      :prefix "SPC"
      :non-normal-prefix "M-SPC"
      "or" '(ranger :which-key "Ranger"))
  )
#+END_SRC
* Projectile
#+BEGIN_SRC emacs-lisp
;; Projectile
(use-package projectile
  :ensure t
  :init
  (setq projectile-require-project-root nil)
  :config
  (projectile-mode 1))
#+END_SRC
* ripgrep
#+BEGIN_SRC emacs-lisp
  (use-package rg
    :ensure t
    :config

    (general-define-key
      :states '(normal visual insert emacs)
      :prefix "SPC"
      :non-normal-prefix "M-SPC"
      "sr" '(rg :which-key "ripgrep")))
#+END_SRC
* Org
*** use-package
#+BEGIN_SRC emacs-lisp
(use-package org
    :config
#+END_SRC
*** Keybindings
#+BEGIN_SRC emacs-lisp
 (general-def 'motion
   "RET" 'org-open-at-point
   "t" 'org-todo)
#+END_SRC
*** Background colors for export
#+BEGIN_SRC emacs-lisp
;; background colors for export http://ivanmalison.github.io/dotfiles/#setbackgroundcolorofsourceblocksforexport
    (progn
    (defun imalison:org-inline-css-hook (exporter)
        "Insert custom inline css to automatically set the
        background of code to whatever theme I'm using's background"
        (when (eq exporter 'html)
        (let* ((my-pre-bg (face-background 'default))
                (my-pre-fg (face-foreground 'default)))
            (setq
            org-html-head-extra
            (concat
            org-html-head-extra
            (format "<style type=\"text/css\">\n pre.src {background-color: %s; color: %s;}</style>\n"
                    my-pre-bg my-pre-fg))))))

    (add-hook 'org-export-before-processing-hook 'imalison:org-inline-css-hook))
#+END_SRC

*** Bullets
https://zhangda.wordpress.com/2016/02/15/configurations-for-beautifying-emacs-org-mode/

#+BEGIN_SRC emacs-lisp
  (use-package org-bullets
  :ensure t
  :config
    ;;(setq org-bullets-bullet-list '("■" "◆" "▲" "▶"))
    (setq org-bullets-bullet-list '("✙" "♱" "♰" "☥" "✞" "✟" "✝" "†" "✠" "✚" "✜" "✛" "✢" "✣" "✤" "✥"))
    ;;(setq org-bullets-bullet-list '("✡" "⎈" "✽" "✲" "✱" "✻" "✼" "✽" "✾" "✿" "❀" "❁" "❂" "❃" "❄" "❅" "❆" "❇"))
    ;;(setq org-bullets-bullet-list '("○" "☉" "◎" "◉" "○" "◌" "◎" "●" "◦" "◯" "⚪" "⚫" "⚬" "❍" "￮" "⊙" "⊚" "⊛" "∙" "∘"))
    ;;(setq org-bullets-bullet-list '("◐" "◑" "◒" "◓" "◴" "◵" "◶" "◷" "⚆" "⚇" "⚈" "⚉" "♁" "⊖" "⊗" "⊘"))
    ;;(setq org-bullets-bullet-list '("♠" "♣" "♥" "♦" "♤" "♧" "♡" "♢"))
    ;;(setq org-bullets-bullet-list '("☯" "☰" "☱" "☲" "☳" "☴" "☵" "☶" "☷"))
    ;;(setq org-bullets-bullet-list '("☀" "♼" "☼" "☾" "☽" "☣" "§" "¶" "‡" "※" "✕" "△" "◇" "▶" "◀" "◈"))

    (add-hook 'org-mode-hook (lambda () (org-bullets-mode 1))))
#+END_SRC
*** misc


"↝" "⇉" "⇝" "⇢" "⇨" "⇰" "➔" "➙" "➛" "➜" "➝" "➞"

"➟" "➠" "➡" "➥" "➦" "➧" "➨"

"➩" "➪" "➮" "➯" "➱" "➲"

"➳" "➵" "➸" "➺" "➻" "➼" "➽"
arrow heads

"➢" "➣" "➤" "≪", "≫", "«", "»"
other arrows

"↞" "↠" "↟" "↡" "↺" "↻"
lightening

"⚡"
other symbols

…, ▼, ↴, , ∞, ⬎, ⤷, ⤵

→

#+BEGIN_SRC emacs-lisp
  (setq org-ellipsis " ↴")
#+END_SRC
*** org-super-agenda
#+BEGIN_SRC emacs-lisp
;; (use-package org-super-agenda
;;   :config (org-super-agenda-mode))

;; (setq org-agenda-custom-commands
;;       '(("c" "Super Agenda" agenda
;;          (org-super-agenda-mode)
;;          ((org-super-agenda-groups
;;            '(
;;              (:name "Next Items"
;;                     :time-grid t
;;                     :tag ("NEXT" "outbox"))
;;              (:name "Important"
;;                     :priority "A")
;;              (:name "Today"
;;                     :time-grid t
;;                     :scheduled today)
;;              (:name "Quick Picks"
;;                     :effort < 00:30 ; ← that one doesn't seem to work, no?
;;                     )
;;              (:priority<= "B"
;;                           :order 1)
;;              )))
;;          (org-agenda nil "a"))))
;; (let ((org-super-agenda-groups
;;        '(;; Each group has an implicit boolean OR operator between its selectors.
;;          (:name "Today"  ; Optionally specify section name
;;                 :time-grid t  ; Items that appear on the time grid
;;                 :todo "TODAY")  ; Items that have this TODO keyword
;;          (:name "Important"
;;                 ;; Single arguments given alone
;;                 :tag "bills"
;;                 :priority "A")
;;          ;; Set order of multiple groups at once
;;          (:order-multi (2 (:name "Shopping in town"
;;                                  ;; Boolean AND group matches items that match all subgroups
;;                                  :and (:tag "shopping" :tag "@town"))
;;                           (:name "Food-related"
;;                                  ;; Multiple args given in list with implicit OR
;;                                  :tag ("food" "dinner"))
;;                           (:name "Personal"
;;                                  :habit t
;;                                  :tag "personal")
;;                           (:name "Space-related (non-moon-or-planet-related)"
;;                                  ;; Regexps match case-insensitively on the entire entry
;;                                  :and (:regexp ("space" "NASA")
;;                                                ;; Boolean NOT also has implicit OR between selectors
;;                                                :not (:regexp "moon" :tag "planet")))))
;;          ;; Groups supply their own section names when none are given
;;          (:todo "WAITING" :order 8)  ; Set order of this section
;;          (:todo ("SOMEDAY" "TO-READ" "CHECK" "TO-WATCH" "WATCHING")
;;                 ;; Show this group at the end of the agenda (since it has the
;;                 ;; highest number). If you specified this group last, items
;;                 ;; with these todo keywords that e.g. have priority A would be
;;                 ;; displayed in that group instead, because items are grouped
;;                 ;; out in the order the groups are listed.
;;                 :order 9)
;;          (:priority<= "B"
;;                       ;; Show this section after "Today" and "Important", because
;;                       ;; their order is unspecified, defaulting to 0. Sections
;;                       ;; are displayed lowest-number-first.
;;                       :order 1)
;;          ;; After the last group, the agenda will display items that didn't
;;          ;; match any of these groups, with the default order position of 99
;;          )))
;;   (org-agenda nil "a"))
#+END_SRC
*** org-archive-subtree-hierachical
#+BEGIN_SRC emacs-lisp
;; org-archive-subtree-hierarchical.el
;; modified from https://lists.gnu.org/archive/html/emacs-orgmode/2014-08/msg00109.html

;; In orgmode
;; * A
;; ** AA
;; *** AAA
;; ** AB
;; *** ABA
;; Archiving AA will remove the subtree from the original file and create
;; it like that in archive target:

;; * AA
;; ** AAA

;; And this give you
;; * A
;; ** AA
;; *** AAA


(require 'org-archive)

(defun org-archive-subtree-hierarchical--line-content-as-string ()
    "Returns the content of the current line as a string"
    (save-excursion
    (beginning-of-line)
    (buffer-substring-no-properties
    (line-beginning-position) (line-end-position))))

(defun org-archive-subtree-hierarchical--org-child-list ()
    "This function returns all children of a heading as a list. "
    (interactive)
    (save-excursion
    ;; this only works with org-version > 8.0, since in previous
    ;; org-mode versions the function (org-outline-level) returns
    ;; gargabe when the point is not on a heading.
    (if (= (org-outline-level) 0)
        (outline-next-visible-heading 1)
        (org-goto-first-child))
    (let ((child-list (list (org-archive-subtree-hierarchical--line-content-as-string))))
        (while (org-goto-sibling)
        (setq child-list (cons (org-archive-subtree-hierarchical--line-content-as-string) child-list)))
        child-list)))

(defun org-archive-subtree-hierarchical--org-struct-subtree ()
    "This function returns the tree structure in which a subtree
belongs as a list."
    (interactive)
    (let ((archive-tree nil))
    (save-excursion
        (while (org-up-heading-safe)
        (let ((heading
                (buffer-substring-no-properties
                (line-beginning-position) (line-end-position))))
            (if (eq archive-tree nil)
                (setq archive-tree (list heading))
            (setq archive-tree (cons heading archive-tree))))))
    archive-tree))

(defun org-archive-subtree-hierarchical ()
    "This function archives a subtree hierarchical"
    (interactive)
    (let ((org-tree (org-archive-subtree-hierarchical--org-struct-subtree))
        (this-buffer (current-buffer))
        (file (abbreviate-file-name
                (or (buffer-file-name (buffer-base-buffer))
                    (error "No file associated to buffer")))))
    (save-excursion
        (setq location (org-get-local-archive-location)
            afile (org-extract-archive-file location)
            heading (org-extract-archive-heading location)
            infile-p (equal file (abbreviate-file-name (or afile ""))))
        (unless afile
        (error "Invalid `org-archive-location'"))
        (if (> (length afile) 0)
            (setq newfile-p (not (file-exists-p afile))
                visiting (find-buffer-visiting afile)
                buffer (or visiting (find-file-noselect afile)))
        (setq buffer (current-buffer)))
        (unless buffer
        (error "Cannot access file \"%s\"" afile))
        (org-cut-subtree)
        (set-buffer buffer)
        (org-mode)
        (goto-char (point-min))
        (while (not (equal org-tree nil))
        (let ((child-list (org-archive-subtree-hierarchical--org-child-list)))
            (if (member (car org-tree) child-list)
                (progn
                (search-forward (car org-tree) nil t)
                (setq org-tree (cdr org-tree)))
            (progn
                (goto-char (point-max))
                (newline)
                (org-insert-struct org-tree)
                (setq org-tree nil)))))
        (newline)
        (org-yank)
        (when (not (eq this-buffer buffer))
        (save-buffer))
        (message "Subtree archived %s"
                (concat "in file: " (abbreviate-file-name afile))))))

(defun org-insert-struct (struct)
    "TODO"
    (interactive)
    (when struct
    (insert (car struct))
    (newline)
    (org-insert-struct (cdr struct))))

(defun org-archive-subtree ()
    (org-archive-subtree-hierarchical)
    )
#+END_SRC
*** Archive location
#+BEGIN_SRC emacs-lisp
(setq org-archive-location "archive/%s_archive::")
#+END_SRC
*** Hide markers
#+BEGIN_SRC emacs-lisp
(setq org-hide-emphasis-markers t)
#+END_SRC
*** Fold everything when opening
#+BEGIN_SRC emacs-lisp
(setq org-startup-indented t)
#+END_SRC
*** No superscripts
#+BEGIN_SRC emacs-lisp
(setq org-export-with-sub-superscripts nil)
#+END_SRC
*** src-blocks
#+BEGIN_SRC emacs-lisp
  (setq org-src-fontify-natively t)
  (setq org-src-tab-acts-natively t)
  (setq org-src-window-setup 'current-window)
#+END_SRC
*** Agenda
#+BEGIN_SRC emacs-lisp
(setq home-org-dir "c:/Users/NOBODY/Documents/Seafile/docs/org/")
(setq work-org-dir "c:/Users/chris.keschnat/Documents/docs/org/")
(setq org-agenda-files
        (cond ((file-directory-p home-org-dir) (list home-org-dir))
            ((file-directory-p work-org-dir) (list work-org-dir))
        )
)

(setq org-agenda-text-search-extra-files '(agenda-archives))
#+END_SRC
*** Not yet sorted
#+BEGIN_SRC emacs-lisp
  ;; TODO(chris) use this?
  ;; (setq org-publish-project-alist
  ;;       '(("org"
  ;;          :base-directory "c:/Users/NOBODY/Documents/Seafile/docs/org/"
  ;;          :publishing-directory "c:/Users/NOBODY/Documents/Seafile/docs/org/html/"
  ;;          :publishing-function org-html-publish-to-html
  ;;          :section-numbers nil
  ;;          :table-of-contents nil)))

  (setq org-blank-before-new-entry '((heading . nil) (plain-list-item . auto)))

  (setq org-enforce-todo-dependencies t)
  (setq org-enforce-todo-checkbox-dependencies t)

  (setq org-log-redeadline (quote time))
  (setq org-log-reschedule (quote time))
  (setq org-log-done (quote time))

  (setq org-clock-persist 'history)
  (org-clock-persistence-insinuate)

  (setq org-default-notes-file (concat (car org-agenda-files) "inbox.org"))
  ;; More headings for refile
  ;; (setq org-refile-targets '((org-agenda-files . (:maxlevel . 6))))
  (setq org-refile-targets '((nil :maxlevel . 9)
                              (org-agenda-files :maxlevel . 9)))
  (setq org-refile-use-outline-path 'file)              ; Show full paths for refiling
  (setq org-outline-path-complete-in-steps nil)         ; Refile in a single go

  (setq helm-org-rifle-show-path t)
  (setq org-refile-allow-creating-parent-nodes 'confirm)

  (setq org-todo-keyword-faces
          '(("TODO" . org-warning)
          ("SOMEDAY" . (:foreground "moccasin" :weight bold))
          ("WAITING" . (:foreground "lavender blush" :weight bold))
          ("CANCELLED" . org-done)))

  (setq org-todo-keywords
          '((sequence "TODO(t)" "WAITING(w)" "SOMEDAY(s)" "|" "CANCELLED(c)" "DONE(d)")))
  (setq org-tag-alist (quote (
                              ("@home" . ?H)
                              ("@work" . ?W)
                              ("WAITING" . ?A)
                              ("PERSONAL" . ?P)
                              ("NOTE" . ?n)
                              ("CANCELLED" . ?C)
                              ("FLAGGED" . ??)
                              ("watch" . ?w)
                              ("read" . ?r)
                              )))

  (setq org-capture-templates
          (quote (("t" "todo" entry (file "") "* TODO %?\n%U\n%a\n")
                  ("n" "note" entry (file "") "* %? :NOTE:\n%U\n%a\n")
                  )))

  (add-to-list 'org-structure-template-alist
                  (list "hh" (concat "#+SETUPFILE: themes/theme-readtheorg-local.setup\n"
                                  "#+OPTIONS: html-postamble:nil num:nil\n"
                                  "#+FILETAGS: ?\n")))

  (add-to-list 'org-structure-template-alist
                  (list "p" (concat ":PROPERTIES:\n"
                                  "?\n"
                                  ":END:")))

  (add-to-list 'org-structure-template-alist
                  (list "eh" (concat ":EXPORT_FILE_NAME: ?\n"
                                  ":EXPORT_TITLE:\n"
                                  ":EXPORT_OPTIONS: html-postamble:nil num:nil")))

  (add-hook 'org-capture-mode-hook 'evil-insert-state)

  (setq org-use-fast-todo-selection t)
  (setq org-todo-state-tags-triggers
          (quote (("CANCELLED" ("CANCELLED" . t))
                  ("WAITING" ("WAITING" . t))
                  (done ("WAITING"))
                  ("" ("WAITING") ("CANCELLED"))
                  ("TODO" ("WAITING") ("CANCELLED"))
                  ("DONE" ("WAITING") ("CANCELLED")))))


  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  ;; https://blog.aaronbieber.com/2016/09/24/an-agenda-for-life-with-org-mode.html
  ;; maybe use https://github.com/alphapapa/org-super-agenda

  (defun air-org-skip-subtree-if-priority (priority)
      "Skip an agenda subtree if it has a priority of PRIORITY.

      PRIORITY may be one of the characters ?A, ?B, or ?C."
      (let ((subtree-end (save-excursion (org-end-of-subtree t)))
          (pri-value (* 1000 (- org-lowest-priority priority)))
          (pri-current (org-get-priority (thing-at-point 'line t))))
      (if (= pri-value pri-current)
          subtree-end
          nil)))

  ;; (setq org-agenda-custom-commands
  ;;       '(("c" "Simple agenda view"
  ;;          ((tags "PRIORITY=\"A\""
  ;;                 ((org-agenda-skip-function '(org-agenda-skip-entry-if 'todo 'done))
  ;;                  (org-agenda-overriding-header "High-priority unfinished tasks:")))
  ;;           (agenda "")
  ;;           (alltodo ""
  ;;                    ((org-agenda-skip-function
  ;;                      '(or (air-org-skip-subtree-if-priority ?A)
  ;;                           (org-agenda-skip-if nil '(scheduled deadline))))))))))

  (setq org-agenda-custom-commands
          '(("d" "Daily agenda and all TODOs"
              ((tags "PRIORITY=\"A\""
                  ((org-agenda-skip-function '(org-agenda-skip-entry-if 'todo 'done))
                      (org-agenda-overriding-header "High-priority unfinished tasks:")))
              (agenda "" ((org-agenda-span 'day)))
              (alltodo ""
                      ((org-agenda-skip-function '(or (air-org-skip-subtree-if-priority ?A)
                                                      (org-agenda-skip-if nil '(scheduled deadline))))
                      (org-agenda-overriding-header "ALL normal priority tasks:"))))
              ((org-agenda-compact-blocks t)))))


  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

  ;; (setq org-agenda-custom-commands
  ;;       (quote (("N" "Notes" tags "NOTE"
  ;;                (
  ;;                 (org-agenda-overriding-header "Notes")
  ;;                 (org-tags-match-list-sublevels t)
  ;;                 )
  ;;                )
  ;;              )
  ;;       )
  ;; )

  (when (display-graphic-p)
    (let* ((variable-tuple (cond ((x-list-fonts "Source Sans Pro") '(:font "Source Sans Pro"))
                                 ((x-list-fonts "Lucida Grande")   '(:font "Lucida Grande"))
                                 ((x-list-fonts "Verdana")         '(:font "Verdana"))
                                 ((x-family-fonts "Sans Serif")    '(:family "Sans Serif"))
                                 (nil (warn "Cannot find a Sans Serif Font.  Install Source Sans Pro."))))
           (base-font-color     (face-foreground 'default nil 'default))
           (headline           `(:inherit default :weight bold :foreground ,base-font-color)))

      (custom-theme-set-faces 'user
                              `(org-level-8 ((t (,@headline ,@variable-tuple))))
                              `(org-level-7 ((t (,@headline ,@variable-tuple))))
                              `(org-level-6 ((t (,@headline ,@variable-tuple))))
                              `(org-level-5 ((t (,@headline ,@variable-tuple))))
                              `(org-level-4 ((t (,@headline ,@variable-tuple :height 1.1))))
                              `(org-level-3 ((t (,@headline ,@variable-tuple :height 1.25))))
                              `(org-level-2 ((t (,@headline ,@variable-tuple :height 1.5))))
                              `(org-level-1 ((t (,@headline ,@variable-tuple :height 1.75))))
                              `(org-document-title ((t (,@headline ,@variable-tuple :height 1.5 :underline nil))))))

    (setq org-fontify-done-headline t)
    (custom-set-faces
     '(org-done ((t (:foreground "PaleGreen"
                     :weight normal
                     :strike-through t))))
     '(org-headline-done
                ((((class color) (min-colors 16) (background dark))
                   (:foreground "LightSalmon" :strike-through t))))))

  ;; circles instead of dashes in lists
  (font-lock-add-keywords 'org-mode
                          '(("^ *\\([-]\\) "
                              (0 (prog1 () (compose-region (match-beginning 1) (match-end 1) "•"))))))
  ) ;; END use-package org
#+END_SRC
*** org-journal
https://www.reddit.com/r/emacs/comments/8kz8dv/tip_how_i_use_orgjournal_to_improve_my/

#+BEGIN_SRC emacs-lisp
  (use-package org-journal
    :ensure t
    :after org
    :init

    (setq org-journal-dir
            (concat (cond
              ((file-directory-p home-org-dir) home-org-dir)
              ((file-directory-p work-org-dir) work-org-dir)) "journal"))

    (setq org-journal-file-format "%Y%m%d.org")
    (setq org-journal-enable-agenda-integration t)
    :config
      (defun org-journal-find-location ()
        ;; Open today's journal, but specify a non-nil prefix argument in order to
        ;; inhibit inserting the heading; org-capture will insert the heading.
        (org-journal-new-entry t)
        ;; Position point on the journal's top-level heading so that org-capture
        ;; will add the new entry as a child entry.
        (goto-char (point-min)))

      (setq org-capture-templates
        (append
          '(("j" "Journal entry" entry (function org-journal-find-location)
            "* TODO %?\n%T\n%i"))
        org-capture-templates))

      (general-define-key
        :states '(normal visual insert emacs)
        :prefix "SPC"
        :non-normal-prefix "M-SPC"
        "j"  '(:ignore t :which-key "Org/Journal")
        "jc" '(org-capture :which-key "org-capture")
        "js" '(org-journal-new-scheduled-entry :which-key "scheduled capture")
        "ji" '(org-clock-in :which-key "org-clock-in")
        "jo" '(org-clock-out :which-key "org-clock-out")))
#+END_SRC
*** htmlize
To export to html.

#+BEGIN_SRC emacs-lisp
(use-package htmlize
  :ensure t)
#+END_SRC

* Navigation
*** Alternate buffer
#+BEGIN_SRC emacs-lisp
(defun spacemacs/alternate-buffer (&optional window)
  "Switch back and forth between current and last buffer in the
current window."
  (interactive)
  (let ((current-buffer (window-buffer window))
        (buffer-predicate
         (frame-parameter (window-frame window) 'buffer-predicate)))
    ;; switch to first buffer previously shown in this window that matches
    ;; frame-parameter `buffer-predicate'
    (switch-to-buffer
     (or (cl-find-if (lambda (buffer)
                       (and (not (eq buffer current-buffer))
                            (or (null buffer-predicate)
                                (funcall buffer-predicate buffer))))
                     (mapcar #'car (window-prev-buffers window)))
         ;; `other-buffer' honors `buffer-predicate' so no need to filter
         (other-buffer current-buffer t)))))
#+END_SRC
*** Movement
#+BEGIN_SRC emacs-lisp
  (general-define-key
    :states '(normal visual insert emacs)
    "C-j" 'forward-paragraph
    "C-k" 'backward-paragraph)

  ;; TODO(chris): make this work (works with eval-region)
  ;; (evil-define-key 'evilified org-agenda-mode-map (kbd "j") 'org-agenda-next-item)
  ;; (evil-define-key 'evilified org-agenda-mode-map (kbd "k") 'org-agenda-previous-item)
#+END_SRC
* Hydra
https://github.com/abo-abo/hydra/wiki/Org-agenda

#+BEGIN_SRC emacs-lisp
  (use-package hydra
    :defer 2
    :config

    ;; Hydra for org agenda (graciously taken from Spacemacs)
    (defhydra hydra-org-agenda (:pre (setq which-key-inhibit t)
                                     :post (setq which-key-inhibit nil)
                                     :hint none)
      "
    Org agenda (_q_uit)

    ^Clock^      ^Visit entry^              ^Date^             ^Other^
    ^-----^----  ^-----------^------------  ^----^-----------  ^-----^---------
    _ci_ in      _SPC_ in other window      _ds_ schedule      _gr_ reload
    _co_ out     _TAB_ & go to location     _dd_ set deadline  _._  go to today
    _cq_ cancel  _RET_ & del other windows  _dt_ timestamp     _gd_ go to date
    _cj_ jump    _o_   link                 _+_  do later      ^^
    ^^           ^^                         _-_  do earlier    ^^
    ^^           ^^                         ^^                 ^^
    ^View^          ^Filter^                 ^Headline^         ^Toggle mode^
    ^----^--------  ^------^---------------  ^--------^-------  ^-----------^----
    _vd_ day        _ft_ by tag              _ht_ set status    _tf_ follow
    _vw_ week       _fr_ refine by tag       _hk_ kill          _tl_ log
    _vt_ fortnight  _fc_ by category         _hr_ refile        _ta_ archive trees
    _vm_ month      _fh_ by top headline     _hA_ archive       _tA_ archive files
    _vy_ year       _fx_ by regexp           _h:_ set tags      _tr_ clock report
    _vn_ next span  _fd_ delete all filters  _hp_ set priority  _td_ diaries
    _vp_ prev span  ^^                       ^^                 ^^
    _vr_ reset      ^^                       ^^                 ^^
    ^^              ^^                       ^^                 ^^
    "
      ;; Entry
      ("hA" org-agenda-archive-default)
      ("hk" org-agenda-kill)
      ("hp" org-agenda-priority)
      ("hr" org-agenda-refile)
      ("h:" org-agenda-set-tags)
      ("ht" org-agenda-todo)
      ;; Visit entry
      ("o"   link-hint-open-link :exit t)
      ("<tab>" org-agenda-goto :exit t)
      ("TAB" org-agenda-goto :exit t)
      ("SPC" org-agenda-show-and-scroll-up)
      ("RET" org-agenda-switch-to :exit t)
      ;; Date
      ("dt" org-agenda-date-prompt)
      ("dd" org-agenda-deadline)
      ("+" org-agenda-do-date-later)
      ("-" org-agenda-do-date-earlier)
      ("ds" org-agenda-schedule)
      ;; View
      ("vd" org-agenda-day-view)
      ("vw" org-agenda-week-view)
      ("vt" org-agenda-fortnight-view)
      ("vm" org-agenda-month-view)
      ("vy" org-agenda-year-view)
      ("vn" org-agenda-later)
      ("vp" org-agenda-earlier)
      ("vr" org-agenda-reset-view)
      ;; Toggle mode
      ("ta" org-agenda-archives-mode)
      ("tA" (org-agenda-archives-mode 'files))
      ("tr" org-agenda-clockreport-mode)
      ("tf" org-agenda-follow-mode)
      ("tl" org-agenda-log-mode)
      ("td" org-agenda-toggle-diary)
      ;; Filter
      ("fc" org-agenda-filter-by-category)
      ("fx" org-agenda-filter-by-regexp)
      ("ft" org-agenda-filter-by-tag)
      ("fr" org-agenda-filter-by-tag-refine)
      ("fh" org-agenda-filter-by-top-headline)
      ("fd" org-agenda-filter-remove-all)
      ;; Clock
      ("cq" org-agenda-clock-cancel)
      ("cj" org-agenda-clock-goto :exit t)
      ("ci" org-agenda-clock-in :exit t)
      ("co" org-agenda-clock-out)
      ;; Other
      ("q" nil :exit t)
      ("gd" org-agenda-goto-date)
      ("." org-agenda-goto-today)
      ("gr" org-agenda-redo)))

     (general-define-key
       :states 'motion
       :keymaps 'org-agenda-mode-map
       "v" 'hydra-org-agenda/body)

#+END_SRC
* puppet
https://github.com/puppetlabs/puppet-syntax-emacs

*** TODO defer loading of puppet stuff

#+BEGIN_SRC emacs-lisp
;;; puppet-mode.el --- A simple mode for editing puppet manifests

;; Copyright (C) 2011 Puppet Labs Inc

;; Author: Russ Allbery <rra@stanford.edu>
;; Maintainer: <info@puppetlabs.com>

;; This file is not part of GNU Emacs.

;; Licensed under the Apache License, Version 2.0 (the "License");
;; you may not use this file except in compliance with the License.
;; You may obtain a copy of the License at
;;
;;     http://www.apache.org/licenses/LICENSE-2.0
;;
;; Unless required by applicable law or agreed to in writing, software
;; distributed under the License is distributed on an "AS IS" BASIS,
;; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
;; See the License for the specific language governing permissions and
;; limitations under the License.

;;; Commentary:

;; A simple mode for editing puppet manifests.

;;; Code:

(defconst puppet-mode-version "0.2")

(defvar puppet-mode-abbrev-table nil
  "Abbrev table in use in puppet-mode buffers.")

(define-abbrev-table 'puppet-mode-abbrev-table ())

(defcustom puppet-indent-level 2
  "*Indentation of Puppet statements."
  :type 'integer :group 'puppet)

(defcustom puppet-include-indent 2
  "*Indentation of continued Puppet include statements."
  :type 'integer :group 'puppet)

(defvar puppet-mode-map
  (let ((map (make-sparse-keymap)))
    (define-key map "\C-j" 'newline-and-indent)
    (define-key map "\C-m" 'newline-and-indent)
    map)
  "Key map used in puppet-mode buffers.")

(defvar puppet-mode-syntax-table
  (let ((table (make-syntax-table)))
    (modify-syntax-entry ?\' "\"'"  table)
    (modify-syntax-entry ?\" "\"\"" table)
    (modify-syntax-entry ?#  "<"    table)
    (modify-syntax-entry ?\n ">#"   table)
    (modify-syntax-entry ?\\ "\\"   table)
    (modify-syntax-entry ?$  "'"    table)
    (modify-syntax-entry ?-  "_"    table)
    (modify-syntax-entry ?:  "_"    table)
    (modify-syntax-entry ?>  "."    table)
    (modify-syntax-entry ?=  "."    table)
    (modify-syntax-entry ?\; "."    table)
    (modify-syntax-entry ?\( "()"   table)
    (modify-syntax-entry ?\) ")("   table)
    (modify-syntax-entry ?\{ "(}"   table)
    (modify-syntax-entry ?\} "){"   table)
    (modify-syntax-entry ?\[ "(]"   table)
    (modify-syntax-entry ?\] ")["   table)
    table)
  "Syntax table in use in puppet-mode buffers.")

(defcustom puppet-indent-tabs-mode nil
  "*Indentation can insert tabs in puppet mode if this is non-nil."
  :type 'boolean :group 'puppet)

(defcustom puppet-comment-column 32
  "*Indentation column of comments."
  :type 'integer :group 'puppet)

(defun puppet-count-matches (re start end)
  "The same as Emacs 22 count-matches, for portability to other versions
of Emacs."
  (save-excursion
    (let ((n 0))
      (goto-char start)
      (while (re-search-forward re end t) (setq n (1+ n)))
      n)))

(defun puppet-comment-line-p ()
  "Return non-nil iff this line is a comment."
  (save-excursion
    (save-match-data
      (beginning-of-line)
      (looking-at (format "\\s-*%s" comment-start)))))

(defun puppet-block-indent ()
  "If point is in a block, return the indentation of the first line of that
block (the line containing the opening brace).  Used to set the indentation
of the closing brace of a block."
  (save-excursion
    (save-match-data
      (let ((opoint (point))
            (apoint (search-backward "{" nil t)))
        (when apoint
          ;; This is a bit of a hack and doesn't allow for strings.  We really
          ;; want to parse by sexps at some point.
          (let ((close-braces (puppet-count-matches "}" apoint opoint))
                (open-braces 0))
            (while (and apoint (> close-braces open-braces))
              (setq apoint (search-backward "{" nil t))
              (when apoint
                (setq close-braces (puppet-count-matches "}" apoint opoint))
                (setq open-braces (1+ open-braces)))))
          (if apoint
              (current-indentation)
            nil))))))

(defun puppet-in-array ()
  "If point is in an array, return the position of the opening '[' of
that array, else return nil."
  (save-excursion
    (save-match-data
      (let ((opoint (point))
            (apoint (search-backward "[" nil t)))
        (when apoint
          ;; This is a bit of a hack and doesn't allow for strings.  We really
          ;; want to parse by sexps at some point.
          (let ((close-brackets (puppet-count-matches "]" apoint opoint))
                (open-brackets 0))
            (while (and apoint (> close-brackets open-brackets))
              (setq apoint (search-backward "[" nil t))
              (when apoint
                (setq close-brackets (puppet-count-matches "]" apoint opoint))
                (setq open-brackets (1+ open-brackets)))))
          apoint)))))

(defun puppet-in-include ()
  "If point is in a continued list of include statements, return the position
of the initial include plus puppet-include-indent."
  (save-excursion
    (save-match-data
      (let ((include-column nil)
            (not-found t))
        (while not-found
          (forward-line -1)
          (cond
           ((bobp)
            (setq not-found nil))
           ((looking-at "^\\s-*include\\s-+.*,\\s-*$")
            (setq include-column
                  (+ (current-indentation) puppet-include-indent))
            (setq not-found nil))
           ((not (looking-at ".*,\\s-*$"))
            (setq not-found nil))))
        include-column))))

(defun puppet-indent-line ()
  "Indent current line as puppet code."
  (interactive)
  (beginning-of-line)
  (if (bobp)
      (indent-line-to 0)                ; First line is always non-indented
    (let ((not-indented t)
          (array-start (puppet-in-array))
          (include-start (puppet-in-include))
          (block-indent (puppet-block-indent))
          cur-indent)
      (cond
       (array-start
        ;; This line probably starts with an element from an array.
        ;; Indent the line to the same indentation as the first
        ;; element in that array.  That is, this...
        ;;
        ;;    exec {
        ;;      "add_puppetmaster_mongrel_startup_links":
        ;;      command => "string1",
        ;;      creates => [ "string2", "string3",
        ;;      "string4", "string5",
        ;;      "string6", "string7",
        ;;      "string3" ],
        ;;      refreshonly => true,
        ;;    }
        ;;
        ;; ...should instead look like this:
        ;;
        ;;    exec {
        ;;      "add_puppetmaster_mongrel_startup_links":
        ;;      command => "string1",
        ;;      creates => [ "string2", "string3",
        ;;                   "string4", "string5",
        ;;                   "string6", "string7",
        ;;                   "string8" ],
        ;;      refreshonly => true,
        ;;    }
        (save-excursion
          (goto-char array-start)
          (forward-char 1)
          (re-search-forward "\\S-")
          (forward-char -1)
          (setq cur-indent (current-column))))
       (include-start
        (setq cur-indent include-start))
       ((and (looking-at "^\\s-*},?\\s-*$") block-indent)
        ;; This line contains a closing brace or a closing brace followed by a
        ;; comma and we're at the inner block, so we should indent it matching
        ;; the indentation of the opening brace of the block.
        (setq cur-indent block-indent))
       (t
        ;; Otherwise, we did not start on a block-ending-only line.
        (save-excursion
          ;; Iterate backwards until we find an indentation hint
          (while not-indented
            (forward-line -1)
            (cond
             ;; Comment lines are ignored unless we're at the start of the
             ;; buffer.
             ((puppet-comment-line-p)
              (if (bobp)
                  (setq not-indented nil)))

             ;; Brace or paren on a line by itself will already be indented to
             ;; the right level, so we can cheat and stop there.
             ((looking-at "^\\s-*[\)}]\\s-*")
              (setq cur-indent (current-indentation))
              (setq not-indented nil))

             ;; Brace (possibly followed by a comma) or paren not on a line by
             ;; itself will be indented one level too much, but don't catch
             ;; cases where the block is started and closed on the same line.
             ((looking-at "^[^\n\({]*[\)}],?\\s-*$")
              (setq cur-indent (- (current-indentation) puppet-indent-level))
              (setq not-indented nil))

             ;; Indent by one level more than the start of our block.  We lose
             ;; if there is more than one block opened and closed on the same
             ;; line but it's still unbalanced; hopefully people don't do that.
             ((looking-at "^.*{[^\n}]*$")
              (setq cur-indent (+ (current-indentation) puppet-indent-level))
              (setq not-indented nil))

             ;; Indent by one level if the line ends with an open paren.
             ((looking-at "^.*\(\\s-*$")
              (setq cur-indent (+ (current-indentation) puppet-indent-level))
              (setq not-indented nil))

             ;; Semicolon ends a block for a resource when multiple resources
             ;; are defined in the same block, but try not to get the case of
             ;; a complete resource on a single line wrong.
             ((looking-at "^\\([^'\":\n]\\|\"[^\n\"]*\"\\|'[^\n']*'\\)*;\\s-*$")
              (setq cur-indent (- (current-indentation) puppet-indent-level))
              (setq not-indented nil))

             ;; Indent an extra level after : since it introduces a resource.
             ((looking-at "^.*:\\s-*$")
              (setq cur-indent (+ (current-indentation) puppet-indent-level))
              (setq not-indented nil))

             ;; Start of buffer.
             ((bobp)
              (setq not-indented nil)))))

        ;; If this line contains only a closing paren, we should lose one
        ;; level of indentation.
        (if (looking-at "^\\s-*\)\\s-*$")
            (setq cur-indent (- cur-indent puppet-indent-level)))))

      ;; We've figured out the indentation, so do it.
      (if (and cur-indent (> cur-indent 0))
          (indent-line-to cur-indent)
        (indent-line-to 0)))))

(defvar puppet-font-lock-syntax-table
  (let* ((tbl (copy-syntax-table puppet-mode-syntax-table)))
    (modify-syntax-entry ?_ "w" tbl)
    tbl))

(defvar puppet-font-lock-keywords
  (list
   ;; defines, classes, and nodes
   '("^\\s *\\(class\\|define\\|node\\)\\s +\\([^( \t\n]+\\)"
     2 font-lock-function-name-face)
   ;; inheritence
   '("\\s +inherits\\s +\\([^( \t\n]+\\)"
     1 font-lock-function-name-face)
   ;; include
   '("\\(^\\|\\s +\\)include\\s +\\(\\([a-zA-Z0-9:_-]+\\(,[ \t\n]*\\)?\\)+\\)"
     2 font-lock-reference-face)
   ;; keywords
   (cons (concat
          "\\b\\(\\("
          (mapconcat
           'identity
           '("alert"
             "case"
             "class"
             "crit"
             "debug"
             "default"
             "define"
             "defined"
             "else"
             "emerg"
             "err"
             "fail"
             "false"
             "file"
             "filebucket"
             "generate"
             "if"
             "import"
             "include"
             "info"
             "inherits"
             "node"
             "notice"
             "realize"
             "search"
             "tag"
             "tagged"
             "template"
             "true"
             "warning"
             )
           "\\|")
          "\\)\\>\\)")
         1)
     ;; variables
     '("\\(^\\|[^_:.@$]\\)\\b\\(true\\|false\\)\\>"
       2 font-lock-variable-name-face)
     '("\\$[a-zA-Z0-9_:]+"
       0 font-lock-variable-name-face)
     ;; usage of types
     '("^\\s *\\([a-z][a-zA-Z0-9_:-]*\\)\\s +{"
       1 font-lock-type-face)
     ;; overrides and type references
     '("\\s +\\([A-Z][a-zA-Z0-9_:-]*\\)\\["
       1 font-lock-type-face)
     ;; general delimited string
     '("\\(^\\|[[ \t\n<+(,=]\\)\\(%[xrqQwW]?\\([^<[{(a-zA-Z0-9 \n]\\)[^\n\\\\]*\\(\\\\.[^\n\\\\]*\\)*\\(\\3\\)\\)"
       (2 font-lock-string-face)))
  "*Additional expressions to highlight in puppet mode.")

;;;###autoload
(defun puppet-mode ()
  "Major mode for editing puppet manifests.

The variable puppet-indent-level controls the amount of indentation.
\\{puppet-mode-map}"
  (interactive)
  (kill-all-local-variables)
  (use-local-map puppet-mode-map)
  (setq mode-name "Puppet")
  (setq major-mode 'puppet-mode)
  (set-syntax-table puppet-mode-syntax-table)
  (set (make-local-variable 'local-abbrev-table) puppet-mode-abbrev-table)
  (set (make-local-variable 'comment-start) "# ")
  (set (make-local-variable 'comment-start-skip) "#+ *")
  (set (make-local-variable 'comment-use-syntax) t)
  (set (make-local-variable 'comment-end) "")
  (set (make-local-variable 'comment-auto-fill-only-comments) t)
  (set (make-local-variable 'comment-column) puppet-comment-column)
  (set (make-local-variable 'indent-line-function) 'puppet-indent-line)
  (set (make-local-variable 'indent-tabs-mode) puppet-indent-tabs-mode)
  (set (make-local-variable 'require-final-newline) t)
  (set (make-local-variable 'paragraph-ignore-fill-prefix) t)
  (set (make-local-variable 'paragraph-start) "\f\\|[   ]*$\\|#$")
  (set (make-local-variable 'paragraph-separate) "\\([  \f]*\\|#\\)$")
  (or (boundp 'font-lock-variable-name-face)
      (setq font-lock-variable-name-face font-lock-type-face))
  (set (make-local-variable 'font-lock-keywords) puppet-font-lock-keywords)
  (set (make-local-variable 'font-lock-multiline) t)
  (set (make-local-variable 'font-lock-defaults)
       '((puppet-font-lock-keywords) nil nil))
  (set (make-local-variable 'font-lock-syntax-table)
       puppet-font-lock-syntax-table)
  (run-hooks 'puppet-mode-hook))

(provide 'puppet-mode)

;;
;; Setup puppet-mode for autoloading
;;
(autoload 'puppet-mode "puppet-mode" "Major mode for editing puppet manifests")

(add-to-list 'auto-mode-alist '("\\.pp$" . puppet-mode))
#+END_SRC
* Company
** TODO evtl. company enter key verbessern
https://emacs.stackexchange.com/questions/13286/how-can-i-stop-the-enter-key-from-triggering-a-completion-in-company-mode

#+BEGIN_SRC emacs-lisp
  (use-package company
    :ensure t
    :diminish
    :custom
      (company-begin-commands '(self-insert-command))
      (company-idle-delay .1)
      (company-minimum-prefix-length 2)
      (company-show-numbers t)
      (company-tooltip-align-annotations 't)
      (company-tooltip-limit 20)
      (company-echo-delay 0)
      (company-dabbrev-downcase nil)
      (global-company-mode t)
    :config
      (use-package company-go
        :ensure t
        :after company
        :diminish))

  ;; https://emacs.stackexchange.com/questions/17537/best-company-backends-lists/17548
  (add-hook 'go-mode-hook
    (lambda ()
      (add-to-list (make-local-variable 'company-backends)
                    'company-go)))
#+END_SRC
* Yasnippets
#+BEGIN_SRC emacs-lisp
  (use-package yasnippet
    :ensure t
    :config
      (use-package yasnippet-snippets
        :ensure t))

  (yas-global-mode 1)
#+END_SRC
** CANCELLED company/yasnippets                                  :CANCELLED:
Look at this if needed.
#+BEGIN_SRC emacs-lisp
  ;; https://emacs.stackexchange.com/questions/10431/get-company-to-show-suggestions-for-yasnippet-names
  ;; Add yasnippet support for all company backends
  ;; https://github.com/syl20bnr/spacemacs/pull/179
  (defvar company-mode/enable-yas t
    "Enable yasnippet for all backends.")

  (defun company-mode/backend-with-yas (backend)
    (if (or (not company-mode/enable-yas) (and (listp backend) (member 'company-yasnippet backend)))
        backend
      (append (if (consp backend) backend (list backend))
              '(:with company-yasnippet))))

  (setq company-backends (mapcar #'company-mode/backend-with-yas company-backends))
#+END_SRC
* Git
#+BEGIN_SRC emacs-lisp
  (use-package magit
    :ensure t
    :config
    (use-package evil-magit
      :ensure t)
    (general-define-key
      :states '(normal visual insert emacs)
      :prefix "SPC"
      :non-normal-prefix "M-SPC"
      "g"  '(:ignore t :which-key "Magit")
      "gg" '(magit :which-key "Magit")
      "gs" '(magit-status :which-key "Status")))
#+END_SRC
* Engine
#+BEGIN_SRC emacs-lisp
  (use-package engine-mode
    :ensure t
    :config
    (progn
      (defengine google "http://google.de/search?q=%s" :keybinding "g")
      (defengine mail "https://mail.google.com/mail/u/0/#search/%s" :keybinding "m")
      (defengine jira "https://TODO" :keybinding "j")
      (engine-mode))

    (general-define-key
      :states '(normal visual insert emacs)
      :prefix "SPC"
      :non-normal-prefix "M-SPC"
      "e"  '(:ignore t :which-key "Engine")
      "eg" '(engine/search-google "goole" :which-key "Google")
      "em" '(engine/search-mail "mail" :which-key "Mail")
      "ej" '(engine/search-jira "jira" :which-key "Jira")))
#+END_SRC
* Gc
#+BEGIN_SRC emacs-lisp
  ;; gc / make org faster
  ;; https://www.reddit.com/r/emacs/comments/55ork0/is_emacs_251_noticeably_slower_than_245_on_windows/d8cmm7v/
  (setq gc-cons-threshold (* 511 1024 1024))
  (setq gc-cons-percentage 0.5)
  (run-with-idle-timer 5 t #'garbage-collect)
  (setq garbage-collection-messages t)
#+END_SRC
* CANCELLED Helm                                                  :CANCELLED:
#+BEGIN_SRC emacs-lisp
;; Helm
(use-package helm
  :ensure t
  :init
  (setq helm-M-x-fuzzy-match t
  helm-mode-fuzzy-match t
  helm-buffers-fuzzy-matching t
  helm-recentf-fuzzy-match t
  helm-locate-fuzzy-match t
  helm-semantic-fuzzy-match t
  helm-imenu-fuzzy-match t
  helm-completion-in-region-fuzzy-match t
  helm-candidate-number-list 150
  helm-split-window-in-side-p t
  helm-move-to-line-cycle-in-source t
  helm-echo-input-in-header-line t
  helm-autoresize-max-height 0
  helm-autoresize-min-height 20)
  :config
  (helm-mode 1))

(global-set-key (kbd "M-x") #'helm-M-x)

(general-define-key
  :states '(normal visual insert emacs)
  :prefix "SPC"
  :non-normal-prefix "M-SPC"
  "SPC" '(helm-M-x :which-key "M-x")
  ;; Buffers
  "bb"  '(helm-buffers-list :which-key "buffers list")
  ;; Files
  "ff"  '(helm-find-files :which-key "find files")
  ;; "/"   '(counsel-rg :which-key "ripgrep") ; You'll need counsel package for this
)
#+END_SRC
